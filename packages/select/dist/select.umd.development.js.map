{"version":3,"file":"select.umd.development.js","sources":["../src/index.ts"],"sourcesContent":["import {\n\tExtractRematchStateFromModels,\n\tModel,\n\tModels,\n\tPlugin,\n\tRematchStore,\n} from '@rematch/core'\nimport { createSelector, createStructuredSelector } from 'reselect'\nimport { SelectConfig } from './types'\n\nconst makeSelect = () => {\n\t/**\n\t * Maps models to structured selector\n\t * @param  mapSelectToStructure function that gets passed `selectors` and returns an object\n\t * @param  structuredSelectorCreator=createStructuredSelector if you need to provide your own implementation\n\t *\n\t * @return the result of calling `structuredSelectorCreator` with the new selectors\n\t */\n\tfunction select(\n\t\tmapSelectToStructure: any,\n\t\tstructuredSelectorCreator = createStructuredSelector\n\t) {\n\t\tlet func = (state: any, props: any): any => {\n\t\t\tfunc = structuredSelectorCreator(mapSelectToStructure(select))\n\t\t\treturn func(state, props)\n\t\t}\n\n\t\treturn (state: any, props: any) => func(state, props)\n\t}\n\n\treturn select\n}\n\nconst makeFactoryGroup = () => {\n\tlet ready = false\n\tconst factories = new Set()\n\treturn {\n\t\tadd(added: any) {\n\t\t\tif (!ready) {\n\t\t\t\tadded.forEach((factory: any) => factories.add(factory))\n\t\t\t} else {\n\t\t\t\tadded.forEach((factory: any) => factory())\n\t\t\t}\n\t\t},\n\t\tfinish(factory: any) {\n\t\t\tfactories.delete(factory)\n\t\t},\n\t\tstartBuilding() {\n\t\t\tready = true\n\t\t\tfactories.forEach((factory: any) => factory())\n\t\t},\n\t}\n}\n\nconst validateConfig = <TModels extends Models<TModels>>(\n\tconfig: SelectConfig<TModels>\n): void => {\n\tif (process.env.NODE_ENV !== 'production') {\n\t\tif (config.sliceState && typeof config.sliceState !== 'function') {\n\t\t\tthrow new Error('select plugin config sliceState must be a function')\n\t\t}\n\n\t\tif (\n\t\t\tconfig.selectorCreator &&\n\t\t\ttypeof config.selectorCreator !== 'function'\n\t\t) {\n\t\t\tthrow new Error('select plugin config selectorCreator must be a function')\n\t\t}\n\t}\n}\n\nconst validateSelector = (\n\tselectorFactories: any,\n\tselectorName: any,\n\tmodel: any\n): void => {\n\tif (process.env.NODE_ENV !== 'production') {\n\t\tif (typeof selectorFactories?.[selectorName] !== 'function') {\n\t\t\tthrow new Error(\n\t\t\t\t`Selector (${model.name}/${selectorName}) must be a function`\n\t\t\t)\n\t\t}\n\t}\n}\n\nconst createSelectPlugin = <\n\tTModels extends Models<TModels>,\n\tTExtraModels extends Models<TModels> = Record<string, any>\n>(\n\tconfig: SelectConfig<TModels> = {}\n): Plugin<TModels, TExtraModels> => {\n\tvalidateConfig(config)\n\n\tconst sliceState: SelectConfig<TModels>['sliceState'] =\n\t\tconfig.sliceState || ((state, model) => state[model.name || ''])\n\tconst selectorCreator = config.selectorCreator || createSelector\n\n\tconst slice = (model: Model<TModels>) => (\n\t\tstateOrNext: ExtractRematchStateFromModels<TModels>\n\t) => {\n\t\tif (typeof stateOrNext === 'function') {\n\t\t\treturn selectorCreator(\n\t\t\t\t(state: ExtractRematchStateFromModels<TModels>) =>\n\t\t\t\t\tsliceState(state, model),\n\t\t\t\tstateOrNext\n\t\t\t)\n\t\t}\n\t\treturn sliceState(stateOrNext, model)\n\t}\n\n\tconst hasProps = (inner: any) =>\n\t\tfunction (this: any, models: any) {\n\t\t\treturn selectorCreator(\n\t\t\t\t(props: any) => props,\n\t\t\t\t(props: any) => inner.call(this, models, props)\n\t\t\t)\n\t\t}\n\n\tconst factoryGroup = makeFactoryGroup()\n\n\tconst select = makeSelect()\n\n\treturn {\n\t\texposed: {\n\t\t\tselect,\n\t\t\t// @ts-ignore\n\t\t\tsliceState,\n\t\t\tselectorCreator,\n\t\t},\n\t\tonModel(model: Model<TModels>) {\n\t\t\t// @ts-ignore\n\t\t\tselect[model.name] = {}\n\n\t\t\tconst selectorFactories =\n\t\t\t\ttypeof model.selectors === 'function'\n\t\t\t\t\t? // @ts-ignore\n\t\t\t\t\t  model.selectors(slice(model), selectorCreator, hasProps)\n\t\t\t\t\t: model.selectors\n\n\t\t\tfactoryGroup.add(\n\t\t\t\tObject.keys(selectorFactories || {}).map((selectorName: string) => {\n\t\t\t\t\tvalidateSelector(selectorFactories, selectorName, model)\n\n\t\t\t\t\tconst factory = () => {\n\t\t\t\t\t\tfactoryGroup.finish(factory)\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tdelete select[model.name][selectorName]\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tselect[model.name][selectorName] = selectorFactories[\n\t\t\t\t\t\t\tselectorName\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t].call(select[model.name], select)\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\treturn select[model.name][selectorName]\n\t\t\t\t\t}\n\n\t\t\t\t\t// Define a getter for early constructing\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tObject.defineProperty(select[model.name], selectorName, {\n\t\t\t\t\t\tconfigurable: true,\n\t\t\t\t\t\tget() {\n\t\t\t\t\t\t\treturn factory()\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\n\t\t\t\t\treturn factory\n\t\t\t\t})\n\t\t\t)\n\t\t},\n\t\t// @ts-ignore\n\t\tonStoreCreated(store: RematchStore) {\n\t\t\tfactoryGroup.startBuilding()\n\t\t\t// @ts-ignore\n\t\t\tstore.select = select\n\t\t},\n\t}\n}\n\nexport default createSelectPlugin\nexport * from './types'\n"],"names":["makeSelect","select","mapSelectToStructure","structuredSelectorCreator","createStructuredSelector","func","state","props","makeFactoryGroup","ready","factories","Set","add","added","forEach","factory","finish","startBuilding","validateConfig","config","sliceState","Error","selectorCreator","validateSelector","selectorFactories","selectorName","model","name","createSelectPlugin","createSelector","slice","stateOrNext","hasProps","inner","models","call","factoryGroup","exposed","onModel","selectors","Object","keys","map","defineProperty","configurable","get","onStoreCreated","store"],"mappings":"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"}